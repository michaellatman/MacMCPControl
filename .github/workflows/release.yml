name: Build and Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_CERTIFICATE_KEY_BASE64: ${{ secrets.APPLE_CERTIFICATE_KEY_BASE64 }}
          APPLE_CERTIFICATE_CER_BASE64: ${{ secrets.APPLE_CERTIFICATE_CER_BASE64 }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          if [[ -n "$APPLE_CERTIFICATE_KEY_BASE64" && -n "$APPLE_CERTIFICATE_CER_BASE64" ]]; then
            KEY_PATH=$RUNNER_TEMP/certificate.key
            CER_PATH=$RUNNER_TEMP/certificate.cer

            echo "APPLE_CERTIFICATE_KEY_BASE64 length: ${#APPLE_CERTIFICATE_KEY_BASE64} bytes"
            echo "APPLE_CERTIFICATE_CER_BASE64 length: ${#APPLE_CERTIFICATE_CER_BASE64} bytes"
            echo "$APPLE_CERTIFICATE_KEY_BASE64" | base64 --decode > "$KEY_PATH"
            echo "$APPLE_CERTIFICATE_CER_BASE64" | base64 --decode > "$CER_PATH"
            echo "Decoded key size: $(wc -c < "$KEY_PATH") bytes"
            echo "Decoded cert size: $(wc -c < "$CER_PATH") bytes"

            security import "$KEY_PATH" -A -k "$KEYCHAIN_PATH"
            security import "$CER_PATH" -A -t cert -k "$KEYCHAIN_PATH"
          else
            CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
            echo "APPLE_CERTIFICATE_BASE64 length: ${#APPLE_CERTIFICATE_BASE64} bytes"
            echo "APPLE_CERTIFICATE_PASSWORD length: ${#APPLE_CERTIFICATE_PASSWORD} chars"
            echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
            echo "Decoded certificate size: $(wc -c < "$CERTIFICATE_PATH") bytes"

            security import "$CERTIFICATE_PATH" \
              -P "$APPLE_CERTIFICATE_PASSWORD" \
              -A \
              -t cert \
              -f pkcs12 \
              -k "$KEYCHAIN_PATH"
          fi

          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Build Release
        run: swift build -c release

      - name: Create App Bundle
        run: |
          APP_PATH="MacMCPControl.app"

          rm -rf "$APP_PATH"
          mkdir -p "$APP_PATH/Contents/MacOS"
          mkdir -p "$APP_PATH/Contents/Resources"

          # Copy the executable
          cp .build/release/MacMCPControl "$APP_PATH/Contents/MacOS/"

          # Copy resources
          cp -R .build/release/MacMCPControl_MacMCPControl.bundle "$APP_PATH/Contents/Resources/"
          cp .build/release/MacMCPControl_MacMCPControl.bundle/AppIcon.icns "$APP_PATH/Contents/Resources/"

          # Create Info.plist
          cat > "$APP_PATH/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>MacMCPControl</string>
              <key>CFBundleIdentifier</key>
              <string>com.macmcpcontrol.app</string>
              <key>CFBundleName</key>
              <string>Mac MCP Control</string>
              <key>CFBundleDisplayName</key>
              <string>Mac MCP Control</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>LSMinimumSystemVersion</key>
              <string>14.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Code Sign App
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          codesign --force --deep --sign "$APPLE_SIGNING_IDENTITY" MacMCPControl.app

      - name: Create Release Archive
        run: |
          zip -r MacMCPControl.zip MacMCPControl.app

      - name: Get Version
        id: version
        run: |
          VERSION=$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Mac MCP Control v${{ steps.version.outputs.version }}
          files: MacMCPControl.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/signing.keychain-db || true
